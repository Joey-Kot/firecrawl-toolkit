name: Publish to PyPI

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type publish to confirm"
        required: true
        default: "publish"

permissions:
  contents: read
  id-token: write

concurrency:
  group: pypi-publish
  cancel-in-progress: false

jobs:
  preflight:
    runs-on: ubuntu-latest

    steps:
      - name: Confirm release intent
        env:
          CONFIRM: ${{ github.event.inputs.confirm }}
        run: |
          if [ "$CONFIRM" != "publish" ]; then
            echo "::error::Input confirm must be exactly publish."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e . pytest build twine

      - name: Run tests
        run: pytest -q

      - name: Build distributions
        run: python -m build

      - name: Validate distributions
        run: python -m twine check dist/*

      - name: Ensure version is not already on PyPI
        run: |
          python - <<"PY"
          import json
          import urllib.error
          import urllib.request
          from pathlib import Path

          import tomllib

          pyproject = tomllib.loads(Path("pyproject.toml").read_text(encoding="utf-8"))
          package_name = pyproject["project"]["name"]
          version = pyproject["project"]["version"]

          url = f"https://pypi.org/pypi/{package_name}/json"
          try:
              with urllib.request.urlopen(url, timeout=15) as resp:
                  data = json.load(resp)
          except urllib.error.HTTPError as exc:
              if exc.code == 404:
                  print(f"Package {package_name!r} does not exist on PyPI yet. Release {version} can proceed.")
                  raise SystemExit(0)
              raise

          if version in data.get("releases", {}):
              print(f"::error::Version {version} already exists on PyPI for {package_name}. Bump pyproject.toml first.")
              raise SystemExit(1)

          print(f"Version {version} is not published yet for {package_name}.")
          PY

      - name: Upload distributions
        uses: actions/upload-artifact@v4
        with:
          name: python-dist
          path: dist/
          if-no-files-found: error

  publish:
    runs-on: ubuntu-latest
    needs: preflight
    environment:
      name: pypi

    steps:
      - name: Download distributions
        uses: actions/download-artifact@v4
        with:
          name: python-dist
          path: dist/

      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
